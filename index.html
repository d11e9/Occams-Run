<html>
	<head>
		<title>Occams Run</title>
		<style>
			html, body {
				margin: 0 auto;
				padding: 0 5em;
				font-family: monospace;
				text-align: center;
				max-width: 40em;

			}
			.header {
				margin: 5em 0;
			}
			.int, .info {
				text-align: left;
				margin-bottom: 5em;
			}
		</style>
		<script src="jquery.min.js"></script>
	</head>
	<body>
		
		<div class="header">
			<h1>
				<img src="logo.png" alt="Occam's Run">
			</h1>
			<p>All things being equal (50/50) only The Brave will win.</p>
		</div>

		<div class="info">
			<p>Occam's Run balance: <span class="occamsBalance">0</span> ETH</p>
			<p>Players: <span class="playerCount">0</span></p>
		</div>

		<div class="int interface0">
			<p>Player 1 account: <span class="balance">0</span> ETH</p>
			<p> <input class="amount" type="text" value="0" /> <button class="send">Send</button> <button class="withdraw">Withdraw</button></p>
		</div>
		
		<div class="int interface1">
			<p>Player 2 account: <span class="balance">0</span> ETH</p>
			<p> <input class="amount" type="text" value="0" /> <button class="send">Send</button> <button class="withdraw">Withdraw</button></p>
		</div>

		<div class="int interface2">
			<p>Player 3 account: <span class="balance">0</span> ETH</p>
			<p> <input class="amount" type="text" value="0" /> <button class="send">Send</button> <button class="withdraw">Withdraw</button></p>
		</div>

		<div class="int interface3">
			<p>Player 4 account: <span class="balance">0</span> ETH</p>
			<p> <input class="amount" type="text" value="0" /> <button class="send">Send</button> <button class="withdraw">Withdraw</button></p>
		</div>


		<script>

			var MOCKACCOUNTS = {
			}


			function Account( address, value, handleReceiveAction ) {
				console.log( 'creating account ' + address + ' with ' + value + ' value. is contract:', typeof handleReceiveAction !== 'undefined' )
				this.address = address;
				this.value = value;
				this.handleReceiveAction = handleReceiveAction
			}



			Account.prototype.register = function(){
				if (MOCKACCOUNTS[this.address]) {
					this.value = MOCKACCOUNTS[this.address];
				} else {
					MOCKACCOUNTS[this.address] = this.value;
				}
			}

			Account.prototype.sendValue = function( toAccount, valueSent, action ) {
				if (valueSent > this.value) {
					console.log('Not enough Funds ('+this.value+') to send', valueSent)
					return false;
				}
				console.log( this.address + ' sent ', valueSent, ' to ', toAccount.address )
				this.value -= valueSent;
				MOCKACCOUNTS[this.address] -= valueSent;
				toAccount.receiveTx( this, valueSent, action );
			}

			Account.prototype.receiveTx = function( fromAccount, valueReceived, action) {
				console.log( this.address + ' recieved ', valueReceived, ' from ', fromAccount.address, ' with action: ', action )
				this.value += valueReceived;
				MOCKACCOUNTS[this.address] += valueReceived;
				if ( this.handleReceiveAction ) {
					this.handleReceiveAction( fromAccount, valueReceived, action )
				}
			}


			function Contract ( address, value, changeCallBack ) {
				var contract = this;

				this.getCoinToss = function(){
					return Math.floor(Math.random() * 2);
				}

				this.account = new Account( address, value, function( sender, val, action ) {
					// Allow withdrawing from the game at no loss.
					if ( action === 'withdraw' ) {
						if (contract.storage[sender.address]) {
							contract.account.sendValue( sender, contract.storage[sender.address] + val , null );
							delete contract.storage[sender.address];
							changeCallBack()
							return true;
						}
					}

					// All things being equal (50/50)
					// Only the brave will win
					// either increase senders wager

					var stake = (contract.storage[sender.address] || 0 )

					if ( contract.getCoinToss() ) {

						console.log( sender.address + ' increased stake by ' + val + ' to a total of ' + (stake + val) )
						contract.storage[sender.address] = stake + val
						changeCallBack()
						return true;

					// or leave them with nothing!
					} else {
						
						console.log( sender.address + ' LOSES: ', stake + val )

						// and distribute their wealth to Remaining players (if any)
						var players = Object.keys( contract.storage )

						if ( players.length > 1 || (players.length == 1 && !contract.storage[sender.address]) ) {
							var payoutTotal = stake + val;

							// TODO: Make distribution proportional to player stake, not equal

							if (contract.storage[sender.address]) {
								console.log( 'Splitting', payoutTotal, ' between ', players.length - 1, ' players.')
								var payout = payoutTotal / ( players.length - 1 );
							} else {
								console.log( 'Splitting', payoutTotal, ' between ', players.length, ' players.')
								var payout = payoutTotal / players.length;
							}

							for (var address in players) {
								if ( players[address] !== sender.address ) {
									var player = new Account( players[address], 0 );
									player.register();

									console.log( 'Distributing ', payout, ' of ', sender.address + 's wealth to player ' + player.address );
									contract.account.sendValue( player, payout );
								}
							}
						} else {
							// its their lucky day and there are no remaining players to distribute weealth to
							// so instead of making a profit this contract will return the wager and their wealth
							console.log( 'It\'s ' + sender.address + 's lucky day have it back')
							contract.account.sendValue( sender, stake + val);
						}

						delete contract.storage[sender.address];
						changeCallBack()
						return false;
					}

				});
				this.account.register();
				this.storage = {};
			}


			function updateInterface () {
				for (var x = 0; x < players.length; x++) {
					$('.interface'+x+' .balance').html( players[x].value )
					$('.playerCount').html( Object.keys(occamsrun.storage).length )
				}

				$('.playerCount').html( Object.keys(occamsrun.storage).length )
				$('.occamsBalance').html( occamsrun.account.value )
			}

			var players = [ new Account('PPP1', 100), new Account('PPP2', 100), new Account('PPP3', 100), new Account('PPP4', 100) ]
			var occamsrun = new Contract( 'CCC1', 0, updateInterface )

			$(function(){

				players[0].register()
				players[1].register()
				players[2].register()
				players[3].register()


				console.log( 'go' );


				// test


				console.log( occamsrun )

				players[1].sendValue( players[2], 10 )

				
				
				for (var x = 0; x < players.length; x++) {

					(function(x){
						$('.interface'+x+' .send').click( function(){
							console.log( players, x )
							players[x].sendValue( occamsrun.account, parseInt( $('.interface'+x+' .amount').val() ) )
							updateInterface( x )
						});

						$('.interface'+x+' .withdraw').click( function(){
							players[x].sendValue( occamsrun.account, 0, 'withdraw' )
							updateInterface( x )
						});
					})(x);

					tick(x, 10);
				}


				

				function tick(x, v) {
					players[x].sendValue( occamsrun.account, v )
					console.log( occamsrun.storage, players[x] )
					var total = 0;
					for (var x = 0; x < players.length; x++) {
						players[x].register();
						total += players[x].value
					}
					updateInterface( x )
					console.log( 'Total Stake: ', occamsrun.account.value, ' Total Player balances:', total, ' checksum: ', total + occamsrun.account.value )
				}
			})


		</script>


	</body>
</html>